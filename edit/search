#!/bin/bash
# mindevenviro search
###     WARNING:    DON'T EDIT ANYTHING BELOW	###
set -x
				if [[ "$EUID" != 0 ]] ;
			then
				echo "sudo search -h :: please"
		else

LANG="C";
IFS=$(echo -en "\n\b") ;
FILE="search";
line='';
lines='';

help(){
shift 0 ;
echo -e "\nUsage: sudo search -s [PATH] [SEARCHPATTERN]| OR [-a] [-g TOGREP] [-e TOEXCLUDE]\n
sudo this script:\n
SEARCH THE DRIVE\r
 This script searches your drive\r
 for everything in it, and displays\r
 only text in the less viewer.\r
 or open a PDF if finds PDF's\n
 Finds: log files, example code, etc.\n
 [PATH]: local filesystem\r
 [SEARCHPATTERN]: some pattern to search, one word\r
 [-a]: search flag \"ALL\" as a globe \"*\"\r
 [TOGREP]: -g flag and a word to grep\r
 [TOEXCLUDE]: -e flag and a word you don't want to be in the search results.\n" ; 
 # SUDO_USER workflow control
exit 0 ;
	}

#exithandler
exitHandl3R(){
	searchStat ;
	pgrep $FILE | awk "{print $1}" | xargs kill -9 && pgrep less | awk "{print $1}" | xargs kill -9;
}

display(){
# display
trap 'exitHandl3R' SIGINT ;

		while read line ;
	do
		wait ;
###main	
		if [[ $(echo "$line" | xargs file) =~ PDF|PHP|script|ASCII|text|TEXT|HTML|XML ]] ;
	then
###1
			if [[ "$togrepFlag" = "-g" ]] ;
		then
			patternOnly="$(echo $line | xargs grep $togrep)" ;
			tosearCH=$patternOnly ;

			elif [[ "$exclud3Flag" = "-e" ]] && [[ "$togrepFlag" = "-g" ]] ;
		then
			patternANDexclude="$(echo $line | xargs grep $togrep && echo $line | xargs | grep -v $exclud3)" ;
			tosearCH=$patternANDexclude ;
			
			elif [[ "$exclud3Flag" = "-e" ]] || [[ "$togrepFlag" = "-g" ]] ;
		then
			patternOnly="$(echo $line | xargs grep $togrep)" ;
			tosearCH=$patternOnly ;
	else
			lineNUR="$(echo $line)" ;
			tosearCH=$lineNUR ;
fi
###1

###2
			if [[ "$tosearCH" != '' ]] ;
		then
			uS3F=$(ls -sl "$line" | awk '{print $4}' | tr -d '\ ');
			
			elif [[ ! $(echo "$line" | xargs file) =~ PDF ]] ;
		then
			sudo -u "$uS3F" less $line;
			pause=1 ;
		else
			sudo -u "$uS3F" mupdf $line 2>/dev/null ;
			pause=1 ;
		fi
###2
			elif [[ ! $(echo "$line" | xargs file) =~ PDF|PHP|script|ASCII|text|TEXT|HTML|XML ]] ;
		then
			echo -e " ... no PDF|PHP|script|ASCII|text|TEXT|HTML|XML \r" ;
			pause=0 ;
		else
			echo -e " ... $(echo $line | xargs file) :: - nothing to show\r" ;
			pause=0 ;
fi
	done <<<"$lines" ;

#display END
}

preP4re(){
		while read line ;
	do
		if [[ $pause = 1 ]] ;
	then
		line=$lines ;
		read -r -p "continue? " && display && wait ;
	else
		line=$lines ;
		display && wait ;
	fi ;
done < <(find ${searchQuery#$searchIndex})
}

eingabe(){
pause=0 ;
globeallflag="-a";
tos3arch="$3";
		if [[ "$globeallflag" = "-a" ]] ;
	then
	toSearch="-name *";
else
	toSearch="-name *$tos3arch*" ;
fi

		if [[ "$togrep" != '' ]] && [[ "$exclud3" = '' ]];
	then
		searchPartone="$path $toSearch -type f | sed 's/\ /\\ /g' | grep -E $togrep ";
		searchQuery="$searchPartone" ;

		elif [[ "$exclud3" != '' ]] && [[ "$togrep" != '' ]];
	then
		searchPartTwo="$path $toSearch -type f | sed 's/\ /\\ /g' | grep -E $togrep | grep -vE $exclud3";
		searchQuery="$searchPartTwo";
fi
preP4re ;
}

searchStat(){
	echo -e "search $(date) :: as $SUDO_USER :: in $(uname -n) :: $path $exclud3 $togrep $exclud3 ::" >>"/home/$SUDO_USER/.wH0rUNSon" && wait ;
}
# ASK
togrepFlag="-g";
exclud3Flag="-e";

  case "$1" in
		-s|--search)
        path=$2
        togrep=$3
        exclud3=$4
        shift "$(echo "$path $togrep $exclud3" | wc -w)" ;
        eingabe "$@" ;
        ;;
        -h|--help)
        toshiffta=0 ;
        shift "$toshiffta" ;
        ;;
esac
fi
