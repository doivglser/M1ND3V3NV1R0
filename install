#!/bin/bash
# mindevenviro install
###		WARNING:	DON'T EDIT ANYTHING BELOW	###
LANG="C" ;
myPrograms="wicd brutalchess libreoffice-writer tidy cheese gimp scrot mupdf terminator playonlinux wine64 wine64-tools wine64-preloader xul-ext-ublock-origin firefox-esr vlc feh xclip geany transmission openvpn xscreensaver vtwm oss-compat alsa-utils xcompmgr x11-apps xdm xorg zip rar openssl clamav-freshclam clamav-milter clamdscan clamav-daemon clamav-base clamav mysql-client mysql-server php7.0 php7.0-cli php7.0-mcrypt php7.0-intl php7.0-mysql php7.0-curl php7.0-gd php7.0-soap php7.0-xml php7.0-zip php7.0-readline php7.0-opcache php7.0-json php7.0-gd dwww apache2 git sendmail python-gtk2-dbg shellcheck libcgi-pm-perl perl nmon fortunes figlet mc mutt eject nano " ;
environinstall="server-monitor redundanz serv-if-up sCRYPtUPdater shi3lD start_shield stop_shield nids-antivirus-up feh-bg hi hi_cheese hi_brutalchess hi_libreoffice hi_geany hi_gimp hi_transmission-gtk hi_firefox-esr hi_playonlinux hi_vlc hi_wicd-client search mysql_cp_db set_mysql_passwd openpdf takeshot install " ;
apPRn='' ;

		if [ ! $EUID = 0 ] ;
	then
		echo "USAGE: sudo install"
		exit 0 ;
else
		if [[ ! $(cat /proc/net/route | head -n2 | awk '{print $1}' | tail -n1) =~ 'eno|eth' ]] ;
	then
		interface="$(cat /proc/net/route | head -n2 | awk '{print $1}' | tail -n1)";
fi
		if [[ "$(df -h | grep -E shm$ | cut -f2 -d% | tr -d '\ ')" != '' ]] ;
	then
		tmpfolder="$(df -h | grep -E shm$ | cut -f2 -d% | tr -d '\ ')" ;
	else
		tmpfolder="/tmp" ;
fi
		if [[ "$(ps aux | grep -v grep | grep -v nano | grep -v geany | grep shi3lD | awk '{print $2}' | wc -l) " -ge "1" ]] ;
	then
		killall -15 shi3lD && wait ;
fi
		if [[ $PWD =~ 'mindevenviro' ]] ;
	then
		nNuM1=$(echo "$environinstall" | wc -w) ;
		nNuM2=$(echo "$myPrograms" | wc -w) ;
		spin2='-\|/' ;
		
		while [[ "$nNuM1" != "0" ]] ;
	do
		clear ;
		toCopyPath=$(awk '{print $'"$nNuM1"'}'<<<"$environinstall") ;
		sudo cp -f "$PWD/$toCopyPath" "/usr/local/bin/$toCopyPath" ;
		sudo chown root:root "/usr/local/bin/$toCopyPath" ;
		sudo chmod 4755 "/usr/local/bin/$toCopyPath" ;
		sudo chmod u+s "/usr/local/bin/$toCopyPath" &&
		echo -e "\n ... copying files ::\n" ;
		i=$(( (i+1) %4 )) ; printf "\r ... ${spin2:$i:1} $toCopyPath ." | tee -a "/home/$SUDO_USER/.installed" ; sleep .1 ;
		((nNuM1--)) ;
done

	echo -e "\r\n ... clearing files" ;
	
	# by an update clear from double entries in 000-default.conf
	sed '/Alias /d' /etc/apache2/sites-available/000-default.conf > $tmpfolder/000-default.conf 2>/dev/null ;
	cp -f $tmpfolder/000-default.conf /etc/apache2/sites-available/000-default.conf 2>/dev/null ;
	
	# by an update clear from double entries in clamd.conf
	sed -e '/ScanOnAccess /d' /etc/clamav/clamd.conf  >| $tmpfolder/clamd.conf 2>/dev/null ;
	cp -f $tmpfolder/clamd.conf /etc/clamav/clamd.conf 2>/dev/null ;
	
	# by an update clear from double entries in clamd.conf
	sed -e '/OnAccessMountPath /d' /etc/clamav/clamd.conf  >| $tmpfolder/clamd.conf 2>/dev/null ;
	cp -f $tmpfolder/clamd.conf /etc/clamav/clamd.conf 2>/dev/null ;	

		if [ -e /root/.vendorsmac ] ;
	then
		echo -e "vendors macs allready saved" ;
	else
	
	echo -e "\n ... save vendors MAC-Address" ;
	touch "/root/.vendorsmac" ;
	ip link show | grep ether | awk '{print $2}' | tee "/root/.vendorsmac" ;
	chmod 0664 "/root/.vendorsmac" ;
fi
	echo -e "\n ... create /home/$SUDO_USER Directories" ;
	mkdir -p /home/$SUDO_USER/{testphp,testbash,testperl,testpython,Downloads,Pictures,Documents,Music,Ableton} ;
	chown -R $SUDO_USER:$SUDO_USER /home/$SUDO_USER ;

	echo -e "\n ... I'm going to install programs\n ... copy sources.list" ;
	cp -f sources.list /etc/apt/sources.list ;
	wget -q "http://deb.playonlinux.com/public.gpg" -O- | sudo apt-key add - ;
	wget "http://deb.playonlinux.com/playonlinux_jessie.list" -O /etc/apt/sources.list.d/playonlinux.list ;
	echo -e "\n ... I do an update" ;	
	apt-get update ;

		# update upgrade
		echo -e "\n ... update upgrade clean and autoremove" ;
		apt-get update && apt-get -f -y -m --allow-change-held-packages upgrade ;

		# change the physiology to original
		apt-get -f -m -y install sysvinit-core ;
		cp -f /usr/share/sysvinit/inittab /etc/inittab ;
		# issuing responsiblity
		echo -e 'Package: *systemd*\nPin: release *\nPin-Priority: -1\n' > /etc/apt/preferences.d/systemd ;
		
		if [[ $(dpkg -l | awk '{print $2}' | sed -n '/systemd/p') =~ "systemd:"|"systemd-shim:"|"libsystemd0:" ]] ;
	then
		# remove odd characters 
		apt-get -f -m -y remove --purge --auto-remove systemd:* systemd-shim:* ;
	else
		echo -e "\n ... systemd allready removed" ;
fi
	printf "your email-address on github.com: "; read eM4il
	
	if	[[ "$eM4il" != '' ]] ;
	then
		sudo -u $SUDO_USER ssh-keygen -t rsa -b 4096 -C "$eM4il"
		eX1tC0de=$(echo $?) ;
		wait ;
		
		if [[ "$eX1tC0de" != 0 ]] ;
	then
		echo -e "\n REMEMBER ssh-keygen -t rsa -b 4096 -C your-email@server.tld \nto add a github.com account" | tee -a /home/$SUDO_USER/.installed ;
	else
		echo "eval $(ssh-agent -s)" >> /home/$SUDO_USER/.bashrc ;
		echo "ssh-add ~/.ssh/id_rsa" >> /home/$SUDO_USER/.bashrc ;
		sudo -u $SUDO_USER ssh-keygen -p ;
	fi
	else
		echo " no github.com email."
fi
		#install
		while [[ "$nNuM2" != "0" ]] ;
	do
		toInst=$(awk '{print $'"$nNuM2"'}'<<<"$myPrograms") ;

		wH3RE=$(dpkg -l | grep $toInst) && exittcod="$(echo $?)";

		if [[ "$exittcod" = "0" ]] ;
	then
		apPR="$toInst, allready installed" ;
		echo -e "\n$apPR" ;
		((nNuM2--)) ;
	else
		echo -e "\ninstalling ${toInst}..." ;
		apt-get -f -m -y --allow-change-held-packages install "$toInst" | tee -a "/home/$SUDO_USER/.installed" ;
		wait ;
		sleep 1 ;
		apPR="$toInst, INSTALLED!" ;
		echo -e "\n$apPR" | tee -a "/home/$SUDO_USER/.installed" ;
		sleep 0.5 ;
		((nNuM2--)) ;
fi
		if [ "$nNuM2" = "0" ]
	then
		echo -e "\n ... apt-get done." ;
		sleep 0.5 ;
fi
		printf "\r ... testing for apps, $nNuM2 remaining, $apPRn" ; sleep 0.5 ;
done
# install END

	echo -e "\n ... set background Pictures" ;
	rm -R /home/$SUDO_USER/Pictures/* 2>/dev/null ;
	unzip wallpapers.zip -d /home/$SUDO_USER/Pictures ;
	chown -R $SUDO_USER:$SUDO_USER /home/$SUDO_USER/Pictures/* ;

	echo -e "\n ... installing flash player for linux" ;
	tar -xf flash_player_npapi_linux.x86_64.tar.gz ;
	sudo cp -f libflashplayer.so /usr/lib/mozilla/plugins/ ;
	sudo cp -rf usr/* /usr/ ;
	rm -dRf LGPL/ usr/ libflashplayer.so license.pdf readme.txt ;

	echo -e "\n ... copy .bashrc" ;
	cp -f bashrc /home/$SUDO_USER/.bashrc ;
	chmod 644 /home/$SUDO_USER/.bashrc ;

	echo -e "\n ... copy mindevenviro.xpm" ;
	cp -f mindevenviro.xpm /usr/share/X11/xdm/pixmaps/mindevenviro.xpm ;
	chmod 644 /usr/share/X11/xdm/pixmaps/mindevenviro.xpm ;

	echo -e "\n ... copy Xresources" ;
	cp -f Xresources /etc/X11/xdm/ ;
	chmod 755 /etc/X11/xdm/Xresources ;

	echo -e "\n ... copy the ini file to /home/$SUDO_USER/.config/mc/" ;
	mkdir -p /home/$SUDO_USER/.config/mc 2>/dev/null ;
	cp -f ini /home/$SUDO_USER/.config/mc/ini ;
	chown $SUDO_USER:$SUDO_USER /home/$SUDO_USER/.config ;

	echo -e "\n ... copy the config file to /home/$SUDO_USER/.config/terminator/config" ;
	mkdir -p /home/$SUDO_USER/.config/terminator 2>/dev/null ;
	cp -f config /home/$SUDO_USER/.config/terminator/config ;
	chown $SUDO_USER:$SUDO_USER /home/$SUDO_USER/.config ;
	
	echo -e "\n ... copy the .twmrc file to /home/$SUDO_USER" ;
	cp -f twmrc /home/$SUDO_USER/.twmrc ;
	chown $SUDO_USER:$SUDO_USER /home/$SUDO_USER/.twmrc ;
	
	echo -e "\n ... copy the .xscreensaver file to /home/$SUDO_USER" ;
	cp -f xscreensaver /home/$SUDO_USER/.xscreensaver ;
	chown $SUDO_USER:$SUDO_USER /home/$SUDO_USER/.xscreensaver ;	
	
	echo -e "\n ... set the upload path for PHP scripts" ;
	rm -f /var/www/html/index*
	mkdir -p /var/www/html/testphp/ 2>/dev/null ;
	cp -f mindevenviro.png /var/www/html/ ;
	cp -f bottom.png /var/www/html/ ;
	chown www-data:www-data /var/www/html/mindevenviro.png ;
	cp -f README.html /var/www/html/ ;
	chown www-data:www-data /var/www/html/README.html ;
	
	echo "Alias /testphp/ /var/www/html/testphp/" >> /etc/apache2/sites-available/000-default.conf ;
	
	echo -e "ScanOnAccess True\nOnAccessMountPath /home/$SUDO_USER/Downloads" >> /etc/clamav/clamd.conf ;
	
	echo -e "\n ... check for cgi-bin on drive" ;
	
		if [[ ! "$(cat /etc/apache2/sites-available/000-default.conf | grep cgi-bin)" =~ ' /usr/lib/cgi-bin/>' ]] ;
	then
		mkdir -p /usr/lib/cgi-bin/ 2>/dev/null ;
		echo -e "\nScriptAlias /cgi-bin/ /usr/lib/cgi-bin/\r
		<Directory "/usr/lib/cgi-bin">\r
		AllowOverride None\r
		Options +ExecCGI +MultiViews +SymLinksIfOwnerMatch\r
		Order allow,deny\r
		Allow from all\r
		</Directory>\n" >> /etc/apache2/sites-available/000-default.conf ;
	else
		echo -e "\n ... cgi-bin dir exists" ;
fi
		echo -e "\n ... update apache2 configuration" ;
		a2enmod cgid ;
		
		echo -e "\n ... restarting apache2 server" ;
		/etc/init.d/apache2 restart ;

		echo -e "\n ... set the rights for .wH0rUNSon " ;
		
		if [ -e /home/$SUDO_USER/.wH0rUNSon ] ;
	then
		echo " ... .wH0rUNSon allready installed" | tee -a "/home/$SUDO_USER/.installed" ;
	else
		touch "/home/$SUDO_USER/.wH0rUNSon" && chown $SUDO_USER:$SUDO_USER "/home/$SUDO_USER/.wH0rUNSon" && chmod 0660 "/home/$SUDO_USER/.wH0rUNSon"  | tee -a "/home/$SUDO_USER/.installed" ;
	fi
		echo -e "\n ... installing snort " ;
		apt-get -f -m -y --allow-change-held-packages install snort ;
		# reconfigure all
		echo -e "\n ... reconfiguring installed packages " ;
		dpkg --configure -a ;
		# add i386 arch in 64bit system, to install wine32
		echo -e "\n ... add i386 arch in 64bit system, to install wine32" ;
		sudo dpkg --add-architecture i386 && sudo apt-get update && sudo apt-get -f -y -m --allow-change-held-packages install wine32 ;
	
		# cleaning the environment
		apt-get clean &&
		apt -f -y -m autoremove &&
		
		# reboot
		echo -e "\n successfully_installed" >> /home/$SUDO_USER/.installed ;
		echo -e "\n\n ... Congratulations we have M1ND3V3NV1R0 successfully installed!\r"
		read -p " ... continue?" ;
		echo -e "\n ... RESTART IN 6 SECONDS...\r" ;
		sleep 6 ;
		init 6 ;
else
		echo -e "\n M1ND3V3NV1R0 allready installed!\n run this script from within the folder M1ND3V3NV1R0, after installation, system will restart." ;
		echo -e "\n you should be in the M1ND3V3NV1R0 folder."
fi
fi
